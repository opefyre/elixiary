<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  
  <!-- Debug toggles -->
  <script>
    window.DEBUG_IMAGES = window.DEBUG_IMAGES ?? false;

    (function setupImageDebugging() {
      if (window.__IMAGE_DEBUG_PATCHED__) return;
      window.__IMAGE_DEBUG_PATCHED__ = true;

      const logPrefixes = [
        '📦',
        '✅',
        '🖼️',
        '🔄',
        '🌐',
        '📡',
        '🔗',
        '🧹',
        '🔌',
        '🔍',
        '👀',
        '🔭',
        '👁️',
        '🎯'
      ];
      const warnPrefixes = ['⚠️', '❌'];

      const originalLog = console.log.bind(console);
      const originalWarn = console.warn.bind(console);

      const shouldSuppress = (prefixes, args) => {
        if (window.DEBUG_IMAGES) return false;
        const [first] = args;
        return typeof first === 'string' && prefixes.some(prefix => first.startsWith(prefix));
      };

      console.log = (...args) => {
        if (shouldSuppress(logPrefixes, args)) return;
        originalLog(...args);
      };

      console.warn = (...args) => {
        if (shouldSuppress(warnPrefixes, args)) return;
        originalWarn(...args);
      };
    })();
  </script>

  <!-- SEO & Meta Tags -->
  <title>Elixiary - Discover Amazing Cocktail Recipes</title>
  <meta name="description" content="Discover and explore an extensive collection of cocktail recipes with detailed ingredients, instructions, and beautiful photography. Find your perfect drink.">
  <meta name="keywords" content="cocktails, recipes, drinks, mixology, bartending, ingredients, alcohol, beverages">
  <meta name="author" content="Elixiary">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.elixiary.com/">
  <meta property="og:title" content="Elixiary - Discover Amazing Cocktail Recipes">
  <meta property="og:description" content="Discover and explore an extensive collection of cocktail recipes with detailed ingredients and instructions.">
  <meta property="og:image" content="https://elixiary.web.app/og-image.jpg">
  <meta property="og:site_name" content="Elixiary">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://www.elixiary.com/">
  <meta property="twitter:title" content="Elixiary - Discover Amazing Cocktail Recipes">
  <meta property="twitter:description" content="Discover and explore an extensive collection of cocktail recipes with detailed ingredients and instructions.">
  <meta property="twitter:image" content="https://elixiary.web.app/og-image.jpg">
  
  <!-- PWA & Icons -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w32-h32-c-rw">
  <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w180-h180-c-rw">
  <link rel="icon" sizes="16x16" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w16-h16-c-rw">
  <link rel="icon" sizes="32x32" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w32-h32-c-rw">
  <link rel="icon" sizes="192x192" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w192-h192-c-rw">
  <link rel="icon" sizes="512x512" href="https://lh3.googleusercontent.com/d/1MG6y6fHcYVunEEP4cFRlRpl3-CwExmPs=w512-h512-c-rw">
  <meta name="theme-color" content="#111827">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Elixiary">
  
<!-- Security -->
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      font-src 'self' https://fonts.gstatic.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      img-src 'self' data: https:;
      connect-src 'self'
        https://api.elixiary.com
        https://www.google-analytics.com
        https://region1.google-analytics.com
        https://stats.g.doubleclick.net
        https://www.googletagmanager.com;
      script-src 'self' 'unsafe-inline' https://www.googletagmanager.com;
    ">

<link rel="preconnect" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://www.google-analytics.com">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://www.elixiary.com/">
  
  <!-- Resource Hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.elixiary.com">
  
  <!-- Modern fonts with display swap -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "https://elixiary.web.app/#org",
      "name": "Elixiary",
      "url": "https://elixiary.web.app/",
      "logo": {
        "@type": "ImageObject",
        "url": "https://elixiary.web.app/og-image.jpg"
      },
      "sameAs": [
        "https://instagram.com/elixiary.ai",
        "https://tiktok.com/@elixiary.ai"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "https://elixiary.web.app/#website",
      "url": "https://elixiary.web.app/",
      "name": "Elixiary",
      "description": "Discover and explore an extensive collection of cocktail recipes",
      "inLanguage": "en",
      "isAccessibleForFree": true,
      "publisher": { "@id": "https://elixiary.web.app/#org" },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://elixiary.web.app/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
  ]
}
</script>

  <style>
    :root{
      /* Light theme colors */
      --bg: #fff;
      --text: #0B0F19;
      --muted: #6B7280;
      --line: #E5E7EB;
      --line-2: #EEF1F4;
      --soft: #F7F8FA;
      --accent: #111827;
      --error: #DC2626;
      --success: #059669;
      --warning: #D97706;
      
      /* Dark theme colors */
      --bg-dark: #0B0F19;
      --text-dark: #F9FAFB;
      --muted-dark: #9CA3AF;
      --line-dark: #374151;
      --line-2-dark: #1F2937;
      --soft-dark: #111827;
      --accent-dark: #F3F4F6;
      
      /* Design tokens */
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 14px 38px rgba(16,24,40,.06);
      --shadow-dark: 0 14px 38px rgba(0,0,0,.3);
      --ring: 0 0 0 4px rgba(17,24,39,.08);
      --ring-dark: 0 0 0 4px rgba(249,250,251,.08);
      --fade: 160ms ease;

      /* Responsive image sizes */
      --thumbW: 160px;
      --thumbH: 220px;
      --detailW: 380px;
      --detailMinH: 520px;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: var(--bg-dark);
        --text: var(--text-dark);
        --muted: var(--muted-dark);
        --line: var(--line-dark);
        --line-2: var(--line-2-dark);
        --soft: var(--soft-dark);
        --accent: var(--accent-dark);
        --shadow: var(--shadow-dark);
        --ring: var(--ring-dark);
      }
    }
    
    /* Force light/dark theme classes */
    [data-theme="light"] {
      --bg: #fff;
      --text: #0B0F19;
      --muted: #6B7280;
      --line: #E5E7EB;
      --line-2: #EEF1F4;
      --soft: #F7F8FA;
      --accent: #111827;
      --shadow: 0 14px 38px rgba(16,24,40,.06);
      --ring: 0 0 0 4px rgba(17,24,39,.08);
    }
    
    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
      --line: var(--line-dark);
      --line-2: var(--line-2-dark);
      --soft: var(--soft-dark);
      --accent: var(--accent-dark);
      --shadow: var(--shadow-dark);
      --ring: var(--ring-dark);
    }
    
    @media (min-width:640px){
      :root{ --thumbW:180px; --thumbH:240px; --detailW:420px; --detailMinH:560px; }
    }
    @media (min-width:1024px){
      :root{ --thumbW:200px; --thumbH:260px; --detailW:460px; --detailMinH:600px; }
    }

    /* Base styles */
    *{box-sizing:border-box}
    html,body{height:100%}
    
    body{
      margin:0; 
      padding-top: 64px;
      font-family:"Plus Jakarta Sans","Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:var(--text); 
      background:var(--bg); 
      line-height:1.55; 
      letter-spacing:.01em;
      -webkit-font-smoothing:antialiased; 
      -moz-osx-font-smoothing:grayscale;
      transition: background-color var(--fade), color var(--fade);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}

    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--accent);
      color: var(--bg);
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
      font-size: 14px;
    }
    .skip-link:focus {
      top: 6px;
    }

    /* Header */
    header{ 
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 9999 !important;
      background: var(--bg); 
      border-bottom: 1px solid var(--line-2);
      backdrop-filter: saturate(120%) blur(6px); 
      transition: box-shadow var(--fade), border-color var(--fade), background-color var(--fade);
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      transform: none !important;
      width: 100% !important;
    }
    header.is-scrolled{
      box-shadow: var(--shadow); 
      border-color: transparent;
      transition: all 0.3s ease;
    }
    .container{max-width:1120px; margin:0 auto; padding:0 20px}
    .nav{height:64px; display:flex; align-items:center; gap:14px; justify-content:space-between}
    .brand{font-weight:700; letter-spacing:.01em; display:flex; align-items:center; gap:10px}
    .home-icon{
      color: var(--accent);
      transition: all var(--fade);
      flex-shrink: 0;
    }
    .brand:hover .home-icon{
      transform: scale(1.05);
      color: var(--text);
    }

    .brand-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      line-height: 1.2;
    }

    .brand-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      transition: color var(--fade);
    }

    .brand-subtitle {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: -2px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: color var(--fade);
    }

    .brand:hover .brand-name {
      color: var(--accent);
    }

    .brand:hover .brand-subtitle {
      color: var(--accent);
      opacity: 0.8;
    }

    /* Mobile navbar optimization */
    @media (max-width: 768px) {
      .nav {
        height: 60px;
        gap: 12px;
        padding: 0 16px;
      }
      
      .brand {
        min-width: 0;
        flex-shrink: 0;
        max-width: 140px;
      }
      
      .brand-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.1;
        min-width: 0;
      }
      
      .brand-name {
        font-size: 1.3rem;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      
      .brand-subtitle {
        display: none; /* Hide subtitle on mobile */
      }
      
      .search-wrap {
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 160px);
      }
      
      .search {
        width: 100%;
        max-width: none;
        padding: 8px 12px !important;
        height: 40px !important;
      }
      
      .search input {
        font-size: 14px !important;
        padding: 0 !important;
        height: auto !important;
      }
      
      .search input::placeholder {
        font-size: 14px !important;
      }
      
      .search svg {
        width: 16px;
        height: 16px;
      }
    }

    @media (max-width: 480px) {
      .nav {
        height: 56px;
        gap: 8px;
        padding: 0 12px;
      }
      
      .brand {
        max-width: 120px;
      }
      
      .brand-name {
        font-size: 1.2rem;
      }
      
      .home-icon {
        width: 18px;
        height: 18px;
      }
      
      .search-wrap {
        max-width: calc(100% - 140px);
      }
      
      .search {
        padding: 6px 10px !important;
        height: 36px !important;
      }
      
      .search input {
        font-size: 13px !important;
        padding: 0 !important;
        height: auto !important;
      }
      
      .search input::placeholder {
        font-size: 13px !important;
      }
      
      .search svg {
        width: 14px;
        height: 14px;
      }
    }

    @media (max-width: 360px) {
      .nav {
        height: 52px;
        gap: 6px;
        padding: 0 8px;
      }
      
      .brand {
        max-width: 100px;
      }
      
      .brand-name {
        font-size: 1.1rem;
      }
      
      .home-icon {
        width: 16px;
        height: 16px;
      }
      
      .search-wrap {
        max-width: calc(100% - 120px);
      }
      
      .search {
        padding: 4px 8px !important;
        height: 32px !important;
      }
      
      .search input {
        font-size: 12px !important;
        padding: 0 !important;
        height: auto !important;
      }
      
      .search input::placeholder {
        font-size: 12px !important;
      }
      
      .search svg {
        width: 12px;
        height: 12px;
      }
    }


    @media (max-width: 768px) {
      body {
        padding-top: 60px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding-top: 56px;
      }
    }

    @media (max-width: 360px) {
      body {
        padding-top: 52px;
      }
    }

    /* Search */
    .search-wrap{display:flex; align-items:center; gap:10px}
    .search{
      display:flex; 
      align-items:center; 
      gap:10px; 
      width:min(520px,64vw);
      background:var(--bg); 
      border:1px solid var(--line); 
      border-radius:999px; 
      padding:10px 14px;
      transition:border-color var(--fade), box-shadow var(--fade), background-color var(--fade);
      box-shadow:0 2px 10px rgba(15,23,42,.03);
    }
    .search:focus-within{border-color:var(--muted); box-shadow:var(--ring)}
    .search svg{flex:0 0 18px; color:var(--muted)}
    .search input{
      border:0; 
      outline:0; 
      background:transparent; 
      width:100%; 
      font-size:14px; 
      color:var(--text);
      font-size: 16px; /* Prevent zoom on iOS */
      font-family: "Plus Jakarta Sans", "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      font-weight: 400;
    }
    .search input::placeholder {
      color: var(--muted);
      font-family: "Plus Jakarta Sans", "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      font-weight: 400;
    }
    .clear{ 
      display:none; 
      border:1px solid var(--line); 
      border-radius:999px; 
      padding:4px 8px; 
      font-size:12px; 
      color:var(--muted);
      background:var(--bg); 
      cursor:pointer; 
      transition:transform var(--fade), box-shadow var(--fade), border-color var(--fade);
      min-height: 44px; /* Better touch target */
    }
    .clear:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(16,24,40,.08)}
    .clear:focus{outline:none; box-shadow:var(--ring)}
    .clear.show{display:inline-flex}

    /* Main spacing */
    main{padding:28px 0; min-height:calc(100vh - 200px)}
    .stack{display:flex; flex-direction:column; gap:22px}

    /* Filters - Elegant Professional Design */
    .filters{
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 24px 28px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px rgba(16,24,40,.03);
      position: relative;
    }
    
    .filters::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.3;
    }
    
    .filter-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .filter-section:last-child {
      margin-bottom: 0;
    }
    
    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.025em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .chip{
      border: 1px solid var(--line); 
      background: var(--bg); 
      color: var(--text); 
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      transition: all var(--fade);
      cursor: pointer;
      min-height: 42px;
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    .chip::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--accent);
      opacity: 0;
      transition: all var(--fade);
      z-index: 0;
      border-radius: inherit;
    }
    
    .chip span {
      position: relative;
      z-index: 1;
    }
    
    .chip:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16,24,40,.08);
      border-color: var(--accent);
    }
    
    .chip:focus{
      outline: none; 
      box-shadow: 0 0 0 3px rgba(17,24,39,.1);
    }
    
    .chip.is-active,
    .chip[aria-pressed="true"]{
      border-color: var(--accent);
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(17,24,39,.15);
    }
    
    .chip.is-active::before,
    .chip[aria-pressed="true"]::before {
      opacity: 0;
    }
    
    .results-count {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }
    
    .results-text {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .results-number {
      color: var(--accent);
      font-weight: 600;
    }
    
    @media (min-width: 768px) {
      .filters {
        padding: 24px 32px;
      }
      
      .filter-section {
        flex-direction: row;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
      }
      
      .filter-label {
        min-width: 120px;
        margin-bottom: 0;
      }
      
      .filter-chips {
        flex: 1;
      }
    }
    

    .filters[style*="display: none"] {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width:1024px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      display:grid; 
      grid-template-columns:1fr var(--thumbW); 
      column-gap:18px; 
      align-items:stretch;
      background:var(--bg); 
      border:1px solid var(--line-2); 
      border-radius:var(--radius); 
      overflow:hidden;
      transition:transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease; 
      will-change:transform;
      text-decoration: none;
    }
    .card:hover{transform:translateY(-3px); box-shadow:var(--shadow); border-color:var(--line)}
    .card:focus{outline:none; box-shadow:var(--ring)}
    .card-body{
      padding:18px 18px; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      min-height:var(--thumbH); 
      gap:10px
    }
    .title{margin:0; font-weight:700; letter-spacing:.01em; font-size:18px}
    .facts{display:flex; flex-direction:column; gap:4px}
    .fact{font-size:13px; color:var(--muted)}
    .fact .label{color:var(--muted); margin-right:8px; font-weight: 500}
    .pills{display:flex; flex-wrap:wrap; gap:8px; margin-top:4px}
    .pill{
      font-size:11px; 
      color:var(--muted); 
      border:1px solid var(--line); 
      padding:4px 8px; 
      border-radius:999px; 
      background:var(--soft)
    }

    .thumb-rail{
      position:relative; 
      width:var(--thumbW); 
      height:var(--thumbH);
      border-left:1px solid var(--line-2); 
      background:var(--soft); 
      overflow:hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .thumb{ 
      width:100%; 
      height:100%; 
      object-fit:cover; /* Changed from contain to cover to fill container */
      background:var(--soft);
      transition:transform 500ms cubic-bezier(.2,.8,.2,1), opacity var(--fade), filter var(--fade); 
      border-radius:0;
    }
    
    .thumb.loading {
      filter: blur(5px);
      opacity: 0.7;
    }
    
    .thumb.loaded {
      filter: blur(0);
      opacity: 1;
    }
    .card:hover .thumb{transform:scale(1.02)}

    /* Enhanced Skeletons */
    .skeleton{
      position:relative; 
      overflow:hidden; 
      background:var(--soft);
      border-radius:8px;
      animation:pulse 1.5s ease-in-out infinite;
    }
    
    .skeleton::after{
      content:""; 
      position:absolute; 
      inset:0;
      background:linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,.6) 25%, 
        rgba(255,255,255,.8) 50%, 
        rgba(255,255,255,.6) 75%, 
        rgba(255,255,255,0) 100%);
      transform:translateX(-100%); 
      animation:shimmer 2s ease-in-out infinite;
    }
    
    [data-theme="dark"] .skeleton {
      background:var(--soft-dark);
    }
    
    [data-theme="dark"] .skeleton::after {
      background:linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,.1) 25%, 
        rgba(255,255,255,.2) 50%, 
        rgba(255,255,255,.1) 75%, 
        rgba(255,255,255,0) 100%);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
      100% { transform: translateX(100%); }
    }
    
    .skeleton-thumb{
      width:100%; 
      height:100%;
      border-radius:12px;
    }
    
    /* Skeleton card specific styles */
    .skeleton-card {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .detail{ display:grid; gap:18px; grid-template-columns:1fr; }
    @media (min-width:900px){ .detail{ grid-template-columns: 1fr var(--detailW); align-items:start; } }
    .detail-rail{ 
      border:1px solid var(--line-2); 
      border-radius:18px; 
      background:var(--soft); 
      display:grid; 
      place-items:center;
      min-height:var(--detailMinH); 
      overflow:hidden; 
      box-shadow:var(--shadow); 
    }
    .detail-img{ width:100%; height:100%; object-fit:contain; background:var(--soft); }
    article{ 
      background:var(--bg); 
      border:1px solid var(--line-2); 
      border-radius:18px; 
      padding:26px; 
      box-shadow:var(--shadow); 
    }
    article h1{margin:0 0 6px; font-size:clamp(28px,3.2vw,36px); letter-spacing:.01em}
    .info{color:var(--muted); font-size:14px; margin-bottom:16px}
    .row{display:flex; flex-wrap:wrap; gap:22px; margin:10px 0 8px}
    .col{flex:1 1 280px}
    .list{margin:10px 0 0; padding-left:18px}
    .list li {
      margin-bottom: 4px;
    }
    .kvs{display:grid; gap:8px}
    .kv{display:flex; gap:6px; align-items:center; color:var(--muted); font-size:14px}
    .kv b{font-weight:600; color:var(--text)}
    .back{ 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:10px 12px; 
      margin-top:18px; 
      border:1px solid var(--line);
      border-radius:999px; 
      color:var(--muted); 
      background:var(--bg); 
      transition:transform var(--fade), box-shadow var(--fade), border-color var(--fade);
      text-decoration: none;
    }
    .back:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(16,24,40,.08); border-color:var(--line)}
    .back:focus{outline:none; box-shadow:var(--ring)}

    /* Loading states */
    .loading-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--line);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .spinner-large {
      width: 24px;
      height: 24px;
      border: 3px solid var(--line);
      border-top: 3px solid var(--accent);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: inherit;
    }
    
    [data-theme="dark"] .loading-overlay {
      background: rgba(17, 24, 39, 0.9);
    }
    
    .loading-text {
      margin-left: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    /* Error states */
    .error-state {
      text-align: center;
      padding: 40px 20px;
    }
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .retry-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      margin-top: 16px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      transition: all var(--fade);
      text-decoration: none;
    }
    .retry-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(16,24,40,.08);
    }
    .retry-btn:focus {
      outline: none;
      box-shadow: var(--ring);
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--warning);
      color: white;
      padding: 12px 20px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateX(-50%) translateY(100px);
      transition: all var(--fade);
    }
    .offline-indicator.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Footer */
    footer{
      border-top:1px solid var(--line-2); 
      padding:24px 0; 
      color:var(--muted); 
      font-size:13px;
      background: var(--soft);
    }

    /* Utilities */
    .fade-in{animation:fade 180ms ease both}
    @keyframes fade{from{opacity:0; transform:translateY(2px)} to{opacity:1; transform:none}}
    .hide{display:none !important}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .center{display:flex; justify-content:center}
    .err{
      color:var(--error); 
      background:rgba(220, 38, 38, 0.1); 
      border:1px solid rgba(220, 38, 38, 0.2); 
      padding:12px 14px; 
      border-radius:12px;
      margin: 20px 0;
    }

    .load-more{ 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:10px 14px; 
      margin:8px auto 0;
      border:1px solid var(--line); 
      border-radius:999px; 
      background:var(--bg); 
      cursor:pointer;
      transition:transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
      color: var(--text);
      font-size: 14px;
      min-height: 44px; /* Better touch target */
    }
    .load-more:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(16,24,40,.08); border-color:var(--line)}
    .load-more:focus{outline:none; box-shadow:var(--ring)}
    .load-more:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    #sentinel{height:1px}

    .live-region {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Focus management */
    .focus-trap {
      outline: none;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --line: #000;
        --line-2: #000;
        --muted: #000;
      }
      [data-theme="dark"] {
        --line: #fff;
        --line-2: #fff;
        --muted: #fff;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion:reduce){
      .card:hover .thumb{transform:none}
      .fade-in{animation:none}
      .search:focus-within{box-shadow:none}
      .chip:hover{transform:none}
      .clear:hover{transform:none}
      .back:hover{transform:none}
      .load-more:hover{transform:none}
      .retry-btn:hover{transform:none}
      .spinner{animation:none}
      *{
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Footer */
    .footer {
      margin-top: 80px;
      margin-bottom: 0;
    }
    
    .footer-cover {
      position: relative;
      height: 60vh;
      min-height: 400px;
      max-height: 600px;
      overflow: hidden;
    }
    
    .cover-image-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .cover-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: grayscale(100%) contrast(1.2);
      transition: all 0.8s ease;
    }
    
    .cover-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(0,0,0,0.7) 0%,
        rgba(0,0,0,0.5) 50%,
        rgba(0,0,0,0.8) 100%
      );
      transition: all 0.8s ease;
    }
    
    .cover-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      z-index: 2;
      max-width: 600px;
      padding: 0 20px;
    }
    
    .cover-title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 16px;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .cover-description {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 32px;
      opacity: 0.9;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .cover-social {
      display: flex;
      gap: 20px;
      justify-content: center;
    }
    
    .cover-social-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      color: white;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all var(--fade);
    }
    
    .cover-social-link:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .cover-social-link svg {
      color: white;
      transition: all var(--fade);
    }
    
    .cover-social-link:hover svg {
      transform: scale(1.1);
    }
    
    .footer-bottom {
      background: var(--bg);
      border-top: 1px solid var(--line);
      padding: 30px 0;
    }
    
    .footer-bottom .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    @media (min-width: 768px) {
      .footer-bottom .container {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }
    
    .footer-links {
      display: flex;
      gap: 24px;
    }
    
    .footer-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all var(--fade);
    }
    
    .footer-link:hover {
      color: var(--accent);
      text-decoration: underline;
    }
    
    .footer-copyright {
      color: var(--muted);
      font-size: 14px;
      font-weight: 400;
    }
    
    @media (max-width: 767px) {
      .footer-cover {
        height: 50vh;
        min-height: 300px;
      }
      
      .cover-title {
        font-size: 36px;
      }
      
      .cover-description {
        font-size: 16px;
      }
      
      .cover-social {
        flex-direction: column;
        gap: 12px;
      }
      
      .cover-social-link {
        justify-content: center;
      }
      
      .footer-links {
        justify-content: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .footer-copyright {
        text-align: center;
      }
    }

    /* Print styles */
    @media print {
      header, footer, .load-more, .retry-btn {
        display: none !important;
      }
      .card, article {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #000;
      }
      body {
        background: white !important;
        color: black !important;
      }
    }
  </style>

<!-- Google Analytics 4 + Consent Mode v2 -->
<script>
  // 1) dataLayer and gtag helper
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }

  // 2) Consent defaults (set BEFORE loading gtag.js)
  gtag('consent', 'default', {
    ad_storage: 'denied',
    analytics_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    wait_for_update: 500
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PJ2GP3Q1K1"></script>
<script>
  // 3) GA init
  gtag('js', new Date());

  // 4) Disable auto page_view (SPA will send manual ones)
  gtag('config', 'G-PJ2GP3Q1K1', {
    send_page_view: false,
    allow_ad_personalization_signals: false
    // ,debug_mode: true  // (optional) enable while testing
  });
</script>

</head>

<body data-theme="light">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div id="live-region" class="live-region" aria-live="polite" aria-atomic="true"></div>
  
  <div id="offline-indicator" class="offline-indicator">
    📡 You're offline. Some features may not work.
  </div>

  <!-- Header -->
  <header id="hdr" role="banner">
    <div class="container">
      <nav class="nav" role="navigation" aria-label="Main navigation">
        <a href="/" class="brand" onclick="return Router.go('/')" aria-label="Elixiary home">
          <svg class="home-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="brand-content">
            <span class="brand-name">Elixiary</span>
            <span class="brand-subtitle">Craft Perfect Cocktails</span>
          </div>
        </a>
        <div class="search-wrap">
          <div class="search" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <label for="q" class="sr-only">Search recipes</label>
            <input 
              id="q" 
              type="search"
              placeholder="Search..." 
              autocomplete="off"
              aria-label="Search recipes by name, tag, mood, or ingredient"
              aria-describedby="search-help"
            />
            <button id="clear" class="clear" type="button" aria-label="Clear search">
              <span aria-hidden="true">✕</span>
              <span class="sr-only">Clear</span>
            </button>
          </div>
          <div id="search-help" class="sr-only">
            Use this search to find cocktail recipes by name, ingredients, tags, or mood
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main id="main-content" role="main">
    <div class="container stack">
      <!-- Filters -->
      <section id="filters" class="filters" role="group" aria-labelledby="filters-heading">
        <h2 id="filters-heading" class="sr-only">Filter recipes</h2>
        
        <div class="filter-section">
          <div class="filter-label" id="category-label">Category</div>
          <div id="cat" class="filter-chips" role="group" aria-labelledby="category-label"></div>
        </div>
        
        <div class="results-count">
          <span class="results-text">
            <span class="results-number" id="count" aria-live="polite">0</span> recipes found
          </span>
        </div>
      </section>

      <!-- List / Detail -->
      <div id="view" class="fade-in" role="region" aria-live="polite" aria-label="Recipe content"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer role="contentinfo" class="footer">
    <!-- Cover Photo Section -->
    <div class="footer-cover">
      <div class="cover-image-container">
        <img src="https://lh3.googleusercontent.com/d/1hAttK6U0rbhGZZjAZx8nCqcZM3JX2BEs=w1920-h1080-c" alt="Elegant cocktail presentation" class="cover-img">
        <div class="cover-overlay"></div>
        <div class="cover-content">
          <h2 class="cover-title">Elixiary</h2>
          <p class="cover-description">Discover the art of mixology with our curated collection of premium cocktail recipes.</p>
          <div class="cover-social">
            <a href="https://instagram.com/elixiary.ai" target="_blank" rel="noopener noreferrer" class="cover-social-link" aria-label="Follow us on Instagram">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5" stroke="currentColor" stroke-width="1.5"/>
                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" stroke="currentColor" stroke-width="1.5"/>
                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <span>Instagram</span>
            </a>
            <a href="https://tiktok.com/@elixiary.ai" target="_blank" rel="noopener noreferrer" class="cover-social-link" aria-label="Follow us on TikTok">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>TikTok</span>
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer Bottom -->
    <div class="footer-bottom">
      <div class="container">
        <div class="footer-links">
          <a href="/privacy" class="footer-link">Privacy</a>
          <a href="/terms" class="footer-link">Terms</a>
          <a href="/contact" class="footer-link">Contact</a>
        </div>
        <div class="footer-copyright">
          © <span id="year"></span> Elixiary. All rights reserved.
        </div>
      </div>
    </div>
  </footer>

<script>
  // ===== CONFIGURATION =====
  const CONFIG = {
    API_BASE: 'https://api.elixiary.com/v1',
    PAGE_SIZE: 12,
    CACHE_TTL_MS: 10 * 60 * 1000, // 10 minutes
    FETCH_TIMEOUT_MS: 12000, // 12 seconds
    DEBOUNCE_MS: 180,
    SCROLL_MARGIN: '400px', // Reduced from 600px
    IMAGE_TIMEOUT_MS: 2500,
    RETRY_ATTEMPTS: 3,
    RETRY_DELAY_MS: 1000
  };

  // ===== STATE MANAGEMENT =====
  const AppState = {
    filter: { category: null, q: '' },
    etag: null,
    page: 1,
    hasMore: true,
    gridEl: null,
    chipsBuilt: false,
    loadingMore: false,
    observer: null,
    retryCount: 0,
    requestId: 0,
    isOnline: navigator.onLine,
    theme: 'light',
    categorySet: new Set(),
    categorySignature: '',
    searchHandlersBound: false,
    schema: {
      homeScript: null,
      homeMarkup: '',
      recipeScript: null
    }
  };

  // ===== UTILITIES =====
  const DEFAULT_META_DESCRIPTION = (() => {
    const meta = document.querySelector('meta[name="description"]');
    return (meta && meta.content) || 'Discover and explore an extensive collection of cocktail recipes with detailed ingredients, instructions, and beautiful photography. Find your perfect drink.';
  })();

  const DEFAULT_PAGE_URLS = (() => {
    const canonicalEl = document.querySelector('link[rel="canonical"]');
    const ogEl = document.querySelector('meta[property="og:url"]');
    const twitterEl = document.querySelector('meta[name="twitter:url"]');

    const fallback = `${location.origin.replace(/\/$/, '')}/`;
    const canonicalHref = (canonicalEl && canonicalEl.getAttribute('href')) || fallback;

    let canonicalUrl;
    try {
      canonicalUrl = new URL(canonicalHref, location.origin);
    } catch (_) {
      canonicalUrl = new URL(fallback);
    }

    const basePath = canonicalUrl.pathname.replace(/^\/+|\/+$/g, '');

    return {
      canonical: canonicalUrl.toString(),
      og: (ogEl && ogEl.getAttribute('content')) || canonicalUrl.toString(),
      twitter: (twitterEl && twitterEl.getAttribute('content')) || canonicalUrl.toString(),
      baseUrl: canonicalUrl,
      basePath
    };
  })();

  const Utils = {
    $: sel => document.querySelector(sel),
    $$: sel => document.querySelectorAll(sel),
    
    esc: s => String(s||'').replace(/[&<>"']/g, c=>({ 
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' 
    }[c])),
    
    fmtDate: s => { 
      if(!s) return ''; 
      const d=new Date(s); 
      return isNaN(d)? s : d.toLocaleDateString(undefined,{
        year:'numeric',month:'short',day:'numeric'
      }); 
    },
    
    labelize: s => String(s||'')
      .replace(/^(cat|glass|style|strength|flavor|energy|occ)_/,'')
      .replace(/_/g,' ')
      .replace(/\b\w/g,m=>m.toUpperCase()),
    
    debounce: (fn, ms = CONFIG.DEBOUNCE_MS) => {
      let t; 
      return (...a) => { 
        clearTimeout(t); 
        t = setTimeout(() => fn(...a), ms); 
      }; 
    },
    
    announce: (message) => {
      const liveRegion = Utils.$('#live-region');
      if (liveRegion) {
        liveRegion.textContent = message;
        // Clear after announcement
        setTimeout(() => {
          liveRegion.textContent = '';
        }, 1000);
      }
    },

    setTitle: (title) => {
      const fullTitle = title ? `${title} · Elixiary` : 'Elixiary - Discover Amazing Cocktail Recipes';
      document.title = fullTitle;

      // Update meta description for detail pages or reset to site-wide message
      const metaDesc = Utils.$('meta[name="description"]');
      if (metaDesc) {
        if (title && title !== 'Elixiary') {
          metaDesc.content = `Learn how to make ${title} with detailed ingredients and instructions. Discover more cocktail recipes at Elixiary.`;
        } else {
          metaDesc.content = DEFAULT_META_DESCRIPTION;
        }
      }
    },

    updateShareUrls: (path = location.pathname) => {
      const canonicalLink = Utils.$('link[rel="canonical"]');
      const ogUrl = Utils.$('meta[property="og:url"]');
      const twitterUrl = Utils.$('meta[name="twitter:url"]');

      if (!canonicalLink && !ogUrl && !twitterUrl) return;

      let slug = Utils.normalizeSlug(path);

      if (slug && DEFAULT_PAGE_URLS.basePath) {
        if (slug === DEFAULT_PAGE_URLS.basePath) {
          slug = '';
        } else if (slug.startsWith(`${DEFAULT_PAGE_URLS.basePath}/`)) {
          slug = slug.slice(DEFAULT_PAGE_URLS.basePath.length + 1);
        }
      }

      const hasSlug = Boolean(slug);
      let resolvedUrl = DEFAULT_PAGE_URLS.canonical;

      if (hasSlug) {
        try {
          resolvedUrl = new URL(slug, DEFAULT_PAGE_URLS.baseUrl).toString();
        } catch (_) {
          resolvedUrl = `${location.origin.replace(/\/$/, '')}/${slug}`;
        }
      }

      if (canonicalLink) {
        canonicalLink.setAttribute('href', hasSlug ? resolvedUrl : DEFAULT_PAGE_URLS.canonical);
      }
      if (ogUrl) {
        ogUrl.setAttribute('content', hasSlug ? resolvedUrl : DEFAULT_PAGE_URLS.og);
      }
      if (twitterUrl) {
        twitterUrl.setAttribute('content', hasSlug ? resolvedUrl : DEFAULT_PAGE_URLS.twitter);
      }
    },

    normalizeSlug: (value = '') => {
      if (typeof value !== 'string') return '';
      const trimmed = value.trim();
      if (!trimmed) return '';

      // Remove origin if a full URL is provided
      let pathname = trimmed;
      if (/^https?:\/\//i.test(trimmed)) {
        try {
          pathname = new URL(trimmed).pathname;
        } catch (_) {
          pathname = trimmed;
        }
      }

      const stripped = pathname.replace(/^\/+|\/+$/g, '');
      if (!stripped) return '';

      // Collapse any duplicate slashes between segments
      return stripped.split('/').filter(Boolean).join('/');
    },

    normalizePath: (value = '/') => {
      const slug = Utils.normalizeSlug(value);
      return slug ? `/${slug}` : '/';
    },

    ensureSchemaCache: () => {
      const current = AppState.schema.homeScript;
      if (!current || !document.contains(current)) {
        const script = document.querySelector('script[type="application/ld+json"]:not([data-schema])');
        if (script) {
          AppState.schema.homeScript = script;
          AppState.schema.homeMarkup = script.textContent || '';
        }
      }
    },

    applyRecipeSchema: (recipe) => {
      if (!recipe) return;
      Utils.ensureSchemaCache();

      const recipeJsonLd = Utils.generateRecipeJsonLd(recipe);
      if (!recipeJsonLd) return;

      let { recipeScript, homeScript } = AppState.schema;

      if (!recipeScript || !document.contains(recipeScript)) {
        recipeScript = document.createElement('script');
        recipeScript.type = 'application/ld+json';
        recipeScript.setAttribute('data-schema', 'recipe');

        if (homeScript && homeScript.parentNode) {
          homeScript.parentNode.insertBefore(recipeScript, homeScript.nextSibling);
        } else {
          (document.head || document.body || document.documentElement).appendChild(recipeScript);
        }

        AppState.schema.recipeScript = recipeScript;
      }

      recipeScript.textContent = JSON.stringify(recipeJsonLd, null, 2);
    },

    restoreHomeSchema: () => {
      Utils.ensureSchemaCache();

      const { recipeScript, homeScript, homeMarkup } = AppState.schema;
      if (recipeScript && recipeScript.parentNode) {
        recipeScript.parentNode.removeChild(recipeScript);
      }
      AppState.schema.recipeScript = null;

      if (homeScript && typeof homeMarkup === 'string') {
        homeScript.textContent = homeMarkup;
      }
    },

    generateRecipeJsonLd: (recipe) => {
      return {
        "@context": "https://schema.org",
        "@type": "Recipe",
        "name": recipe.name,
        "description": recipe.instructions || "A delicious cocktail recipe",
        "image": recipe.image_url || recipe.image_thumb,
        "author": {
          "@type": "Organization",
          "name": "Elixiary"
        },
        "recipeCategory": recipe.category,
        "recipeCuisine": "Cocktail",
        "prepTime": recipe.prep_time,
        "recipeIngredient": (recipe.ingredients || []).map(ing => 
          `${ing.measure || ''} ${ing.name || ''}`.trim()
        ),
        "recipeInstructions": recipe.instructions,
        "nutrition": {
          "@type": "NutritionInformation",
          "alcoholContent": recipe.alcohol_content || "Varies"
        }
      };
    }
  };

  // ===== CACHE MANAGEMENT =====
  const CacheManager = {
    keyBase: () => 'mixology:index:' + JSON.stringify({
      q: AppState.filter.q,
      category: AppState.filter.category
    }),
    
    get: (key) => {
      try { 
        const s = localStorage.getItem(key); 
        if (!s) return null; 
        const v = JSON.parse(s); 
        if (v.exp && Date.now() > v.exp) { 
          localStorage.removeItem(key); 
          return null; 
        } 
        return v; 
      } catch { 
        return null; 
      }
    },
    
    put: (key, val, ttlMs = CONFIG.CACHE_TTL_MS) => {
      try { 
        localStorage.setItem(key, JSON.stringify({
          exp: Date.now() + ttlMs, 
          ...val
        })); 
      } catch(e) {
        console.warn('Cache storage failed:', e);
      }
    },
    
    clearSearch: () => {
      try {
        Object.keys(localStorage).forEach(k => { 
          if (k.startsWith('mixology:index:')) localStorage.removeItem(k); 
        });
      } catch(e) {
        console.warn('Cache clear failed:', e);
      }
    }
  };

  // ===== NETWORK LAYER =====
  const APIClient = {
    async fetchWithRetry(url, options = {}, retries = CONFIG.RETRY_ATTEMPTS) {
      for (let i = 0; i < retries; i++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => 
            controller.abort(new Error('timeout')), CONFIG.FETCH_TIMEOUT_MS
          );
          
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          return response;
          
        } catch (error) {
          if (i === retries - 1) throw error;
          
          // Wait before retry
          await new Promise(resolve => 
            setTimeout(resolve, CONFIG.RETRY_DELAY_MS * (i + 1))
          );
        }
      }
    },

    async fetchList({page, ifEtag}) {
      const url = new URL(`${CONFIG.API_BASE}/list`);
      url.searchParams.set('type', 'list');  // CRITICAL: Specify list type
      url.searchParams.set('page', String(page));
      url.searchParams.set('page_size', String(CONFIG.PAGE_SIZE));
      url.searchParams.set('view', 'full'); // CRITICAL: Include images in response
      
      if (AppState.filter.q) url.searchParams.set('q', AppState.filter.q);
      if (AppState.filter.category) url.searchParams.set('category', AppState.filter.category);

      if (ifEtag) {
        url.searchParams.set('if_etag', ifEtag);
      }

      // Remove If-None-Match header due to CORS restrictions
      try {
        const res = await this.fetchWithRetry(url.toString(), {
          credentials: 'omit'
        });

        if (res.status === 304) return { ok: true, not_modified: true };

        const data = await res.json().catch(() => ({ok: false}));
        if (data && data.ok) {
          const newTag = res.headers.get('ETag') || data.etag || null;
          return { ...data, etag: newTag };
        }
        return { ok: false, error: data?.error || 'Failed to load recipes.' };
        
      } catch(e) {
        console.error('API Error:', e);
        if (e.name === 'AbortError' || e.message === 'timeout') {
          return { ok: false, error: 'Request timed out. Please check your connection.' };
        }
        return { ok: false, error: 'Network error. Please check your connection.' };
      }
    },

    async fetchPost(slug) {
      try {
        const res = await this.fetchWithRetry(
          `${CONFIG.API_BASE}/post/${encodeURIComponent(slug)}`,
          { credentials: 'omit' }
        );
      return await res.json();
      } catch(e) {
        console.error('API Error:', e);
        return { ok: false, error: 'Failed to load recipe.' };
      }
    }
  };

  // ===== THEME MANAGEMENT =====
  const ThemeManager = {
    init() {
      this.applyTheme(this.detectTheme());
      this.setupTimeBasedTheme();
    },

    detectTheme() {
      try {
        const now = new Date();
        const hour = now.getHours();
        
        // Dark theme from 6 PM (18:00) to 6 AM (06:00)
        // Light theme from 6 AM (06:00) to 6 PM (18:00)
        const isDarkTime = hour >= 18 || hour < 6;
        
        return isDarkTime ? 'dark' : 'light';
      } catch (error) {
        console.warn('Failed to detect theme based on time, defaulting to light theme:', error);
        return 'light';
      }
    },

    applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      AppState.theme = theme;
      console.log(`Applied ${theme} theme based on time of day`);
    },

    setupTimeBasedTheme() {
      // Check for theme changes every minute
      setInterval(() => {
        const newTheme = this.detectTheme();
        if (newTheme !== AppState.theme) {
          this.applyTheme(newTheme);
        }
      }, 60000); // Check every minute
    }
  };

  // ===== ERROR HANDLING =====
  const ErrorHandler = {
    showError(message, canRetry = false) {
      const view = Utils.$('#view');
      const retryButton = canRetry ? `
        <button class="retry-btn" onclick="ErrorHandler.retry()" type="button">
          <span aria-hidden="true">🔄</span> Try Again
        </button>
      ` : '';
      
      view.innerHTML = `
        <div class="error-state">
          <div class="error-icon" aria-hidden="true">⚠️</div>
          <h2>Oops! Something went wrong</h2>
          <p>${Utils.esc(message)}</p>
          ${retryButton}
        </div>
      `;
      
      Utils.announce(`Error: ${message}`);
    },

    showEmpty(message = "No recipes found matching your search.") {
      const view = Utils.$('#view');
      view.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon" aria-hidden="true">🍸</div>
          <h2>No recipes found</h2>
          <p>${Utils.esc(message)}</p>
          <p>Try adjusting your search or filters.</p>
        </div>
      `;
      
      Utils.announce(message);
    },

    retry() {
      if (AppState.retryCount < CONFIG.RETRY_ATTEMPTS) {
        AppState.retryCount++;
        Router.render();
      } else {
        this.showError('Unable to connect. Please check your internet connection.', false);
      }
    }
  };

  // ===== NETWORK STATUS =====
  const NetworkManager = {
    init() {
      window.addEventListener('online', this.handleOnline.bind(this));
      window.addEventListener('offline', this.handleOffline.bind(this));
      this.updateStatus();
    },

    handleOnline() {
      AppState.isOnline = true;
      this.updateStatus();
      Utils.announce('Connection restored');
      // Retry failed requests
      Router.render();
    },

    handleOffline() {
      AppState.isOnline = false;
      this.updateStatus();
      Utils.announce('You are now offline');
    },

    updateStatus() {
      const indicator = Utils.$('#offline-indicator');
      if (indicator) {
        indicator.classList.toggle('show', !AppState.isOnline);
      }
    }
  };

  // ===== IMAGE MANAGEMENT =====
  const ImageManager = {
    imageCache: new Map(), // Cache for loaded images
    urlCache: new Map(), // Cache for converted URLs
    persistentCache: null, // Persistent localStorage cache
    
    // Initialize persistent image cache
    initPersistentCache() {
      if (!this.persistentCache) {
        const cached = CacheManager.get('mixology:images');
        this.persistentCache = cached ? new Map(Object.entries(cached.data || {})) : new Map();
      }
    },

    // Save image cache to localStorage
    savePersistentCache() {
      try {
        const cacheData = Object.fromEntries(this.persistentCache);
        CacheManager.put('mixology:images', { data: cacheData }, 24 * 60 * 60 * 1000); // 24 hours
      } catch (error) {
        console.warn('Failed to save image cache:', error);
      }
    },

    // Get cached image URL
    getCachedImageUrl(slug) {
      this.initPersistentCache();
      return this.persistentCache.get(slug);
    },

    // Cache image URL
    cacheImageUrl(slug, imageUrl) {
      this.initPersistentCache();
      this.persistentCache.set(slug, imageUrl);
      this.savePersistentCache();
    },

    convertToDirectImageUrl(url) {
      if (!url) return url;
      
      if (this.urlCache.has(url)) {
        return this.urlCache.get(url);
      }
      
      let fileId = null;
      
      if (url.includes('drive.google.com/uc')) {
        const match = url.match(/id=([a-zA-Z0-9_-]+)/);
        fileId = match ? match[1] : null;
      }
      
      if (url.includes('drive.google.com/thumbnail')) {
        const match = url.match(/id=([a-zA-Z0-9_-]+)/);
        fileId = match ? match[1] : null;
      }
      
      if (url.includes('drive.google.com/file/d/')) {
        const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        fileId = match ? match[1] : null;
      }
      
      let convertedUrl = url;
      if (fileId) {
        // Try the most reliable format for embedding
        convertedUrl = `https://lh3.googleusercontent.com/d/${fileId}=w1200-h1200-c`;
      }
      
      // Cache the converted URL
      this.urlCache.set(url, convertedUrl);
      return convertedUrl;
    },
    
    getAlternativeImageUrl(url) {
      if (!url) return url;
      
      let fileId = null;
      const idMatch = url.match(/id=([a-zA-Z0-9_-]+)/);
      if (idMatch) {
        fileId = idMatch[1];
      } else {
        const fileMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        fileId = fileMatch ? fileMatch[1] : null;
      }
      
      if (fileId) {
        // Alternative formats that sometimes work better
        if (url.includes('googleusercontent.com')) {
          return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
        } else {
          return `https://drive.google.com/uc?export=view&id=${fileId}`;
        }
      }
      
      return url;
    },
    
    loadImageWithBlurEffect(img, imageUrl) {
      const thumbRail = img.closest('.thumb-rail');
      if (thumbRail) {
        thumbRail.classList.add('skeleton');
      }
      
      img.classList.add('loading');
      
      const tempImg = new Image();
      
      tempImg.onload = () => {
        img.src = imageUrl;
        img.classList.remove('loading');
        img.classList.add('loaded');
        
        if (thumbRail) {
          thumbRail.classList.remove('skeleton');
        }
        
        if (img.recipeData) {
          this.cacheImageUrl(img.recipeData.slug, imageUrl);
        }
      };
      
      tempImg.onerror = () => {
        img.classList.remove('loading');
        if (thumbRail) {
          thumbRail.classList.remove('skeleton');
        }
        this.handleImageError(img);
      };
      
      tempImg.src = imageUrl;
    },
    
    async loadRealImage(img, recipe) {
      
      const persistentImageUrl = this.getCachedImageUrl(recipe.slug);
      if (persistentImageUrl) {
        const thumbRail = img.closest('.thumb-rail');
        if (thumbRail) {
          thumbRail.classList.add('skeleton');
        }
        
        img.src = persistentImageUrl;
        img.classList.add('loaded');
        img.dataset.realImage = 'loaded';
        
        setTimeout(() => {
          if (thumbRail) {
            thumbRail.classList.remove('skeleton');
          }
        }, 100);
        
        return;
      }
      
      const cacheKey = recipe.slug;
      if (this.imageCache.has(cacheKey)) {
        const cachedData = this.imageCache.get(cacheKey);
        console.log(`📦 Found memory cached data for ${recipe.name}:`, cachedData);
        if (cachedData.image_url || cachedData.image_thumb) {
          const directUrl = this.convertToDirectImageUrl(cachedData.image_url || cachedData.image_thumb);
          
          const thumbRail = img.closest('.thumb-rail');
          if (thumbRail) {
            thumbRail.classList.add('skeleton');
          }
          
          img.src = directUrl;
          img.classList.add('loaded');
          img.dataset.realImage = 'loaded';
          this.cacheImageUrl(recipe.slug, directUrl); // Save to persistent cache
          
          setTimeout(() => {
            if (thumbRail) {
              thumbRail.classList.remove('skeleton');
            }
          }, 100);
          
          console.log(`✅ Applied memory cached image for ${recipe.name}`);
        }
        return;
      }
      
      const listImageUrl = recipe.image_url || recipe.image_thumb;
      if (listImageUrl) {
        console.log(`🖼️ Using list image for ${recipe.name}: ${listImageUrl}`);

        this.imageCache.set(cacheKey, {
          image_url: recipe.image_url || null,
          image_thumb: recipe.image_thumb || null
        });

        const directImageUrl = this.convertToDirectImageUrl(listImageUrl);
        console.log(`🔄 Converted list URL for ${recipe.name}: ${directImageUrl}`);

        this.loadImageWithBlurEffect(img, directImageUrl);
        img.dataset.realImage = 'loaded';
        return;
      }

      try {
        console.log(`🌐 Fetching detail data for: ${recipe.slug}`);
        const response = await APIClient.fetchPost(recipe.slug);
        console.log(`📡 API response for ${recipe.name}:`, response);

        if (response.ok && response.post) {
          const realImageUrl = response.post.image_url || response.post.image_thumb;
          console.log(`🔗 Found image URL for ${recipe.name}:`, realImageUrl);

          this.imageCache.set(cacheKey, {
            image_url: response.post.image_url,
            image_thumb: response.post.image_thumb
          });

          if (realImageUrl) {
            console.log(`🖼️ Testing image load for ${recipe.name}: ${realImageUrl}`);

            const directImageUrl = this.convertToDirectImageUrl(realImageUrl);
            console.log(`🔄 Converted URL: ${directImageUrl}`);

            this.loadImageWithBlurEffect(img, directImageUrl);
            img.dataset.realImage = 'loaded';
            this.cacheImageUrl(recipe.slug, directImageUrl); // Cache the working URL
            console.log(`✅ Successfully loaded image for ${recipe.name}`);
          } else {
            console.warn(`⚠️ No image URL found for ${recipe.name}`);
          }
        } else {
          console.warn(`❌ API call failed for ${recipe.name}:`, response);
        }
      } catch (error) {
        console.error(`💥 Error fetching image for ${recipe.name}:`, error);
      }
    },

    getPlaceholderImage(recipe) {
      const category = recipe?.category || 'cocktail';
      const name = recipe?.name || 'Recipe';
      const color = this.getCategoryColor(category);
      
      const truncatedName = name.substring(0, 20);
      const displayName = `${truncatedName}${name.length > 20 ? '...' : ''}`;
      const escapedName = Utils.esc(displayName);

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 260" style="background:${color}">
          <g transform="translate(100,130)">
            <path d="M-30,-20 L30,-20 L0,40 Z" fill="white" fill-opacity="0.8"/>
            <rect x="-2" y="40" width="4" height="30" fill="white" fill-opacity="0.8"/>
            <rect x="-20" y="70" width="40" height="6" fill="white" fill-opacity="0.8"/>
            <circle cx="10" cy="-5" r="3" fill="#10B981" fill-opacity="0.9"/>
          </g>
          <text x="100" y="200" text-anchor="middle" fill="white" font-size="12" font-family="system-ui">
            ${escapedName}
          </text>
        </svg>
      `.trim();
      
      const encodedSvg = btoa(unescape(encodeURIComponent(svg)));
      return `data:image/svg+xml;base64,${encodedSvg}`;
    },

    getCategoryColor(category) {
      const colors = {
        'cat_shot_shooter': '#DC2626',
        'cat_beer_cocktail': '#D97706', 
        'cat_ordinary_drink': '#059669',
        'cat_cocktail': '#7C3AED',
        'default': '#6B7280'
      };
      return colors[category] || colors.default;
    },

    cleanup() {
      if (this.imageObserver) {
        this.imageObserver.disconnect();
        this.imageObserver = null;
        console.log('🧹 Cleaned up image observer');
      }
    },

    wireImages(root) {
    const imgs = (root || document).querySelectorAll('img.thumb:not([data-wired])');
      console.log(`🔌 Wiring ${imgs.length} images`);
      
      imgs.forEach(img => {
      img.dataset.wired = '1';

        const card = img.closest('.card');
        const recipeData = card ? this.extractRecipeData(card) : null;
        console.log(`🔍 Image found, recipe data:`, recipeData);

        if (img.complete) this.validateImage(img);

        img.addEventListener('load', () => this.validateImage(img), { passive: true });
        img.addEventListener('error', () => this.handleImageError(img));

        if (recipeData && !img.dataset.realImage) {
          const cachedUrl = this.getCachedImageUrl(recipeData.slug);
          if (cachedUrl) {
            img.src = cachedUrl;
            img.dataset.realImage = 'loaded';
          } else {
            this.observeImageForLazyLoad(img, recipeData);
          }
        }

        setTimeout(() => {
          if (!img.complete || img.naturalWidth === 0) {
            this.handleImageError(img);
          }
        }, CONFIG.IMAGE_TIMEOUT_MS);
      });
    },

    extractRecipeData(card) {
      const titleEl = card.querySelector('.title');
      const href = card.getAttribute('href');

      if (!titleEl || !href) return null;

      const slug = Utils.normalizeSlug(href);
      const name = titleEl.textContent.trim();
      const imageUrl = card.dataset.imageUrl || null;
      const imageThumb = card.dataset.imageThumb || null;

      return {
        slug,
        name,
        image_url: imageUrl || null,
        image_thumb: imageThumb || null
      };
    },

    observeImageForLazyLoad(img, recipe) {
      console.log(`👀 Setting up lazy load observer for: ${recipe.name}`);
      
      if (!this.imageObserver) {
        console.log('🔭 Creating new IntersectionObserver for images');
        this.imageObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            console.log(`👁️ Image intersection changed for: ${entry.target.alt}, intersecting: ${entry.isIntersecting}`);
            if (entry.isIntersecting && !entry.target.dataset.realImage) {
              const recipeData = entry.target.recipeData;
              console.log(`🎯 Image came into view, recipe data:`, recipeData);
              if (recipeData) {
                this.loadRealImage(entry.target, recipeData);
                this.imageObserver.unobserve(entry.target);
              } else {
                console.warn('⚠️ No recipe data found on image element');
              }
            }
          });
        }, {
          rootMargin: '50px' // Start loading when 50px away from viewport
        });
      }

      img.recipeData = recipe;
      this.imageObserver.observe(img);
      console.log(`✅ Started observing image for: ${recipe.name}`);
    },

    validateImage(img) {
      if (!img.naturalWidth || !img.naturalHeight) {
        this.handleImageError(img);
      }
    },

    handleImageError(img) {
    const alt = img.dataset.alt || img.dataset.full || '';
      if (!img.dataset.fallbackAttempted && alt) {
        img.dataset.fallbackAttempted = '1';
      img.src = alt;
      } else {
      img.style.opacity = '0';
      const rail = img.closest('.thumb-rail');
      if (rail) rail.classList.add('skeleton');
    }
  }
  };

  // ===== UI COMPONENTS =====
  const UIComponents = {
    skeletonCards(n = 8) {
      const card = `
        <div class="card skeleton-card" role="article" aria-label="Loading recipe">
          <div class="card-body">
            <div class="skeleton" style="height:18px; width:65%; border-radius:8px; margin-bottom:12px" aria-hidden="true"></div>
            <div class="skeleton" style="height:14px; width:45%; border-radius:6px; margin-bottom:8px" aria-hidden="true"></div>
            <div class="skeleton" style="height:12px; width:70%; border-radius:6px; margin-bottom:10px" aria-hidden="true"></div>
            <div class="skeleton" style="height:10px; width:35%; border-radius:4px" aria-hidden="true"></div>
          </div>
          <div class="thumb-rail">
            <div class="skeleton skeleton-thumb" aria-hidden="true"></div>
          </div>
        </div>`;
      return `<section class="grid" role="feed" aria-label="Recipe list">${Array.from({length:n}).map((_, i) => {
        const delay = i * 0.1;
        return card.replace('skeleton-card', `skeleton-card" style="animation-delay: ${delay}s`);
      }).join('')}</section>`;
    },

    createCard(recipe) {
      return `
        <a class="card fade-in"
           href="/${encodeURIComponent(recipe.slug)}"
           data-image-url="${Utils.esc(recipe.image_url || '')}"
           data-image-thumb="${Utils.esc(recipe.image_thumb || '')}"
           onclick="return Router.go('/${encodeURIComponent(recipe.slug)}')"
           role="article"
           aria-label="Recipe: ${Utils.esc(recipe.name || 'Untitled')}">
          <div class="card-body">
            <h3 class="title">${Utils.esc(recipe.name || 'Untitled')}</h3>
            <div class="facts">
              ${recipe.date ? `<div class="fact">
                <span class="label">Date</span>
                <span>${Utils.esc(Utils.fmtDate(recipe.date))}</span>
              </div>`:''}
              ${recipe.difficulty ? `<div class="fact">
                <span class="label">Difficulty</span>
                <span>${Utils.esc(recipe.difficulty)}</span>
              </div>`:''}
              ${recipe.prep_time ? `<div class="fact">
                <span class="label">Prep</span>
                <span>${Utils.esc(recipe.prep_time)}</span>
              </div>`:''}
            </div>
            ${recipe.tags?.length ? `<div class="pills">
              ${recipe.tags.slice(0,3).map(t=>
                `<span class="pill">${Utils.esc(Utils.labelize(t))}</span>`
              ).join('')}
            </div>` : ''}
          </div>
          <div class="thumb-rail skeleton">
            <img class="thumb" 
                 loading="lazy" 
                 decoding="async"
                 src="${Utils.esc(recipe.image_url || recipe.image_thumb || ImageManager.getPlaceholderImage(recipe))}"
                 data-alt="${Utils.esc(recipe.image_thumb || ImageManager.getPlaceholderImage(recipe))}"
                 alt="${Utils.esc(recipe.name || '')}"
                 onload="this.closest('.thumb-rail').classList.remove('skeleton')"
                 onerror="ImageManager.handleImageError(this)">
          </div>
        </a>`;
    }
  };

  // ===== FILTER MANAGEMENT =====
  const FilterManager = {
    reset() {
      AppState.categorySet = new Set();
      AppState.categorySignature = '';
      AppState.chipsBuilt = false;
    },

    mergeCategories(posts) {
      if (!Array.isArray(posts) || !posts.length) return;

      if (!(AppState.categorySet instanceof Set)) {
        AppState.categorySet = new Set();
      }

      posts.forEach(post => {
        if (post && post.category) {
          AppState.categorySet.add(post.category);
        }
      });
    },

    buildChips() {
      const categories = Array.from(AppState.categorySet || []);
      const signature = categories.join('|');

      if (AppState.chipsBuilt && AppState.categorySignature === signature) {
        this.updateChipStates();
        return;
      }

      this.createChipGroup(categories, 'category', '#cat');
      this.setupChipHandlers();
      this.setupSearchHandlers();

      AppState.chipsBuilt = true;
      AppState.categorySignature = signature;
    },

    createChipGroup(items, key, selector) {
      const container = Utils.$(selector);
      if (!container) return;

      const chips = [
        `<button class="chip ${AppState.filter[key] === null ? 'is-active' : ''}" 
                 data-k="${key}" 
                 data-v="" 
                 type="button"
                 role="button"
                 aria-pressed="${AppState.filter[key] === null ? 'true' : 'false'}">
           <span>All</span>
         </button>`
      ];

      items.forEach(value => {
        chips.push(`
          <button class="chip ${AppState.filter[key] === value ? 'is-active' : ''}" 
                   data-k="${key}" 
                   data-v="${Utils.esc(value)}" 
                   type="button"
                   role="button"
                   aria-pressed="${AppState.filter[key] === value ? 'true' : 'false'}"
                   aria-label="Filter by ${key}: ${Utils.esc(Utils.labelize(value))}">
            <span>${Utils.esc(Utils.labelize(value))}</span>
          </button>
        `);
      });

      container.innerHTML = chips.join('');
    },

    updateChipStates() {
      Utils.$$('.chip[data-k="category"]').forEach(btn => {
        const isActive = (btn.dataset.v || '') === (AppState.filter.category || '');
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    },

    setupChipHandlers() {
      Utils.$$('.chip').forEach(btn => {
        // Clone the button to remove all event listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
      });
      
      // Add fresh event listeners
      Utils.$$('.chip').forEach(btn => {
        btn.addEventListener('click', this.handleChipClick.bind(this));
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.handleChipClick(e);
          }
        });
      });
    },

    handleChipClick(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const btn = e.target.closest('.chip');
      if (!btn) return;
      
      const key = btn.dataset.k;
      const val = btn.dataset.v || null;
      
      if (!key) return;
      
      AppState.filter[key] = val;
      CacheManager.clearSearch();
      
      this.updateChipStates();
      
      Utils.announce(`Filter changed to ${key}: ${val || 'All'}`);
      Renderer.renderList(true);
    },

    setupSearchHandlers() {
      if (AppState.searchHandlersBound) return;

      const searchInput = Utils.$('#q');
      const clearBtn = Utils.$('#clear');

      if (searchInput) {
        searchInput.addEventListener('input', Utils.debounce(() => {
          AppState.filter.q = searchInput.value.trim().toLowerCase();
          clearBtn?.classList.toggle('show', !!AppState.filter.q);
          CacheManager.clearSearch();
          Renderer.renderList(true);
          
          if (AppState.filter.q) {
            Utils.announce(`Searching for: ${AppState.filter.q}`);
          }
        }, CONFIG.DEBOUNCE_MS));
      }

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if (searchInput) searchInput.value = '';
          AppState.filter.q = '';
          clearBtn.classList.remove('show');
          CacheManager.clearSearch();
          Utils.announce('Search cleared');
          Renderer.renderList(true);
        });
      }

      AppState.searchHandlersBound = true;
    }
  };

  // ===== INFINITE SCROLL =====
  const InfiniteScroll = {
    setup() {
      if (AppState.observer) AppState.observer.disconnect();
      
      const sentinel = Utils.$('#sentinel');
      if (!sentinel) return;

      AppState.observer = new IntersectionObserver(async (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting && AppState.hasMore && !AppState.loadingMore) {
            await this.loadNextPage();
          }
        }
      }, { 
        root: null, 
        rootMargin: CONFIG.SCROLL_MARGIN, 
        threshold: 0 
      });

      AppState.observer.observe(sentinel);
    },

    async loadNextPage() {
      AppState.loadingMore = true;
      const nextPage = AppState.page + 1;

      const moreBtn = Utils.$('#moreBtn');
      if (moreBtn) {
        moreBtn.disabled = true;
        moreBtn.innerHTML = `
          <div class="loading-indicator">
            <span class="spinner spinner-large" aria-hidden="true"></span>
            <span class="loading-text">Loading more recipes...</span>
          </div>
        `;
      }

      const baseKey = CacheManager.keyBase();
      const pageKey = `${baseKey}:p${nextPage}`;
      const cached = CacheManager.get(pageKey);

      if (cached) {
        Renderer.appendCards(cached.posts);
        FilterManager.buildChips();
        AppState.page = nextPage;
        AppState.hasMore = cached.has_more;
        this.updatePager();
        AppState.loadingMore = false;
      return;
    }

      const data = await APIClient.fetchList({ page: nextPage });
      
      if (data && data.ok) {
        if (data.etag) {
          AppState.etag = data.etag;
          CacheManager.put('mixology:etag', { val: AppState.etag });
        }
        
        CacheManager.put(pageKey, {
          etag: AppState.etag,
          posts: data.posts,
          total: data.total,
          has_more: data.has_more
        });
        
        Renderer.appendCards(data.posts);
        FilterManager.buildChips();
        AppState.page = nextPage;
        AppState.hasMore = data.has_more;
        
        Utils.announce(`Loaded ${data.posts.length} more recipes`);
      } else {
        Utils.announce('Failed to load more recipes');
      }

      this.updatePager();
      AppState.loadingMore = false;
    },

    updatePager() {
      const pager = Utils.$('#pager');
      const moreBtn = Utils.$('#moreBtn');
      
      if (pager) pager.classList.toggle('hide', !AppState.hasMore);
      
      if (moreBtn) {
        moreBtn.disabled = false;
        moreBtn.innerHTML = 'Load more';
      }
    }
  };

  // ===== MAIN RENDERER =====
  const Renderer = {
    async renderList(reset) {
      const view = Utils.$('#view');

      const requestToken = ++AppState.requestId;

      Utils.restoreHomeSchema();

      // Ensure filters are visible on list pages
      const filtersEl = Utils.$('#filters');
      if (filtersEl) {
        filtersEl.style.display = 'block';
        filtersEl.style.visibility = 'visible';
        filtersEl.style.height = 'auto';
        filtersEl.style.overflow = 'visible';
        filtersEl.style.margin = '';
        filtersEl.style.padding = '';
      }
      
      if (reset) {
        AppState.page = 1;
        AppState.hasMore = true;
        AppState.loadingMore = false;
        view.innerHTML = UIComponents.skeletonCards();
        AppState.etag = (CacheManager.get('mixology:etag') || {}).val || null;
        FilterManager.reset();
        if (AppState.observer) {
          AppState.observer.disconnect();
          AppState.observer = null;
        }
      }

      const baseKey = CacheManager.keyBase();
      const firstKey = `${baseKey}:p1`;
      const cached = CacheManager.get(firstKey);

      if (reset && cached) {
        AppState.etag = cached.etag || AppState.etag || null;
        this.paintCards(cached.posts, cached.total, cached.has_more, true);
        FilterManager.buildChips();
      }

      const data = await APIClient.fetchList({
        page: 1,
        ifEtag: cached?.etag || AppState.etag
      });

      if (requestToken !== AppState.requestId) {
        return;
      }

      if (!data.ok) {
        if (requestToken !== AppState.requestId) {
          return;
        }
        if (!cached) {
          if (!AppState.isOnline) {
            ErrorHandler.showError('You are offline. Please check your connection.', true);
          } else {
            ErrorHandler.showError(data.error || 'Failed to load recipes.', true);
          }
        }
        return;
      }

      if (!data.not_modified) {
        AppState.etag = data.etag || AppState.etag;
        CacheManager.put('mixology:etag', { val: AppState.etag });
        CacheManager.put(firstKey, {
          etag: AppState.etag,
          posts: data.posts,
          total: data.total,
          has_more: data.has_more
        });

        this.paintCards(data.posts, data.total, data.has_more, true);
        FilterManager.buildChips();
      }

      AppState.page = 1;
      AppState.hasMore = cached ? cached.has_more : (data.has_more ?? true);
      InfiniteScroll.setup();
      
      AppState.retryCount = 0;
    },

    paintCards(posts, total, hasMore, replace) {
      const view = Utils.$('#view');
      const countEl = Utils.$('#count');

      if (!Array.isArray(posts)) {
        posts = [];
      }

      FilterManager.mergeCategories(posts);

      if (countEl) countEl.textContent = String(total ?? posts.length);

      if (!posts.length) {
        ErrorHandler.showEmpty();
      return;
    }

      const cards = posts.map(recipe => UIComponents.createCard(recipe)).join('');

      if (replace) {
    view.innerHTML = `
          <section class="grid" id="grid" role="feed" aria-label="Recipe list">
          </section>
          <div class="center" id="pager">
            <button class="load-more" id="moreBtn" type="button" onclick="InfiniteScroll.loadNextPage()">
              Load more
            </button>
            <div id="sentinel" aria-hidden="true"></div>
          </div>
        `;
        AppState.gridEl = Utils.$('#grid');
      }

      if (AppState.gridEl) {
        AppState.gridEl.innerHTML = cards;
      }

      AppState.hasMore = !!hasMore;
      const pager = Utils.$('#pager');
      if (pager) pager.classList.toggle('hide', !AppState.hasMore);

      ImageManager.wireImages(AppState.gridEl);
    },

    appendCards(newPosts) {
      if (!Array.isArray(newPosts) || !newPosts.length) return;

      FilterManager.mergeCategories(newPosts);

      const cards = newPosts.map(recipe => UIComponents.createCard(recipe)).join('');
      
      if (AppState.gridEl) {
        AppState.gridEl.insertAdjacentHTML('beforeend', cards);
        ImageManager.wireImages(AppState.gridEl);
      }
    },

    async renderDetail(slug) {
      const view = Utils.$('#view');

      const filtersEl = Utils.$('#filters');
      if (filtersEl) {
        filtersEl.style.display = 'none';
        filtersEl.style.visibility = 'hidden';
        filtersEl.style.height = '0';
        filtersEl.style.overflow = 'hidden';
        filtersEl.style.margin = '0';
        filtersEl.style.padding = '0';
      }
      
    view.innerHTML = `
      <div class="detail skeleton-card">
        <article>
            <div class="skeleton" style="height:32px; width:70%; border-radius:10px; margin-bottom:16px" aria-hidden="true"></div>
            <div class="skeleton" style="height:16px; width:40%; border-radius:8px; margin-bottom:20px" aria-hidden="true"></div>
            <div class="skeleton" style="height:14px; width:95%; border-radius:6px; margin-bottom:12px" aria-hidden="true"></div>
            <div class="skeleton" style="height:14px; width:85%; border-radius:6px; margin-bottom:12px" aria-hidden="true"></div>
            <div class="skeleton" style="height:14px; width:90%; border-radius:6px; margin-bottom:20px" aria-hidden="true"></div>
            <div class="skeleton" style="height:200px; width:100%; border-radius:12px" aria-hidden="true"></div>
        </article>
          <div class="detail-rail">
            <div class="skeleton skeleton-thumb" style="width:100%; height:100%" aria-hidden="true"></div>
          </div>
        </div>
      `;

      const response = await APIClient.fetchPost(slug);
      
      if (!response.ok || !response.post) {
        Utils.setTitle();
        Utils.updateShareUrls();
        ErrorHandler.showError('Recipe not found.', false);
        return null;
      }

      const recipe = response.post;
      Utils.setTitle(recipe.name || 'Recipe');
      Utils.updateShareUrls(slug);

      Utils.applyRecipeSchema(recipe);

      const escHTML = s => Utils.esc(String(s||'')).replace(/\n/g,'<br>');
      const ingredientsList = (recipe.ingredients || []).map(ing => 
        `<li>${Utils.esc(ing.measure||'')} ${Utils.esc(ing.name||'')}</li>`
      ).join('');
      const tags = (recipe.tags || []).map(tag => 
        `<span class="pill">${Utils.esc(Utils.labelize(tag))}</span>`
      ).join('');
      const moods = (recipe.mood_labels || []).map(mood => 
        `<span class="pill">${Utils.esc(Utils.labelize(mood))}</span>`
      ).join('');

      const imageSection = (recipe.image_url || recipe.image_thumb) ? `
        <div class="detail-rail">
          <img class="detail-img"
               src="${Utils.esc(recipe.image_url || recipe.image_thumb)}"
               data-alt="${Utils.esc(recipe.image_thumb || '')}" 
               alt="${Utils.esc(recipe.name||'')}"
               onload="if(!this.naturalWidth||!this.naturalHeight){ this.onerror(); }"
               onerror="ImageManager.handleImageError(this)">
        </div>
      ` : `<div class="detail-rail skeleton" aria-hidden="true"></div>`;

      view.innerHTML = `
      <div class="detail fade-in">
        <article>
            <h1>${Utils.esc(recipe.name || 'Untitled')}</h1>
          <div class="info">
              ${Utils.esc(Utils.fmtDate(recipe.date) || '')}
              ${recipe.difficulty ? ` · ${Utils.esc(recipe.difficulty)}` : ''}
              ${recipe.prep_time ? ` · ${Utils.esc(recipe.prep_time)}` : ''}
          </div>

          <div class="row">
            <div class="col">
                <h3 style="margin:0 0 6px;font-size:16px">Ingredients</h3>
                <ul class="list">${ingredientsList || '<li>—</li>'}</ul>
            </div>
            <div class="col">
                <h3 style="margin:0 0 6px;font-size:16px">Details</h3>
              <div class="kvs">
                  <div class="kv"><b>Category</b> ${Utils.esc(Utils.labelize(recipe.category || '-'))}</div>
                  <div class="kv"><b>Glass</b> ${Utils.esc(Utils.labelize(recipe.glass || '-'))}</div>
                  <div class="kv"><b>Garnish</b> ${Utils.esc(Utils.labelize(recipe.garnish || '-'))}</div>
              </div>
            </div>
          </div>

            <h3 style="margin-top:16px;font-size:16px">Instructions</h3>
            <div>${escHTML(recipe.instructions || 'No instructions available.')}</div>

            ${tags ? `
              <h3 style="margin-top:16px;font-size:16px">Tags</h3>
              <div class="pills">${tags}</div>
            ` : ''}
            
            ${moods ? `
              <h3 style="margin-top:12px;font-size:16px">Mood</h3>
              <div class="pills">${moods}</div>
            ` : ''}

            <p>
              <a class="back" href="/" onclick="return Router.go('/')" role="button">
                <span aria-hidden="true">←</span> Back to all recipes
              </a>
            </p>
        </article>
          ${imageSection}
        </div>
      `;

      Utils.announce(`Loaded recipe: ${recipe.name}`);
      return recipe;
    }
  };

  // ===== ROUTER =====
  const Router = {
    init() {
      window.addEventListener('popstate', () => {
        this.render();
        setTimeout(trackPageView, 0);
      });
      this.render();
      setTimeout(trackPageView, 0); // initial load
    },

    go(path) {
      const normalizedPath = Utils.normalizePath(path);
      history.pushState({}, '', normalizedPath);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      this.render();
      // Track after content/title update
      setTimeout(trackPageView, 0);
      return false;
    },

    render() {
      const year = new Date().getFullYear();
      const yearEl = Utils.$('#year');
      if (yearEl) yearEl.textContent = year;

      // Clean up image observers before rendering new content
      ImageManager.cleanup();

      const slug = Utils.normalizeSlug(location.pathname);
      const filtersEl = Utils.$('#filters');

      if (!slug) {
        // Home page - show filters
        if (filtersEl) filtersEl.style.display = 'block';
        Utils.setTitle();
        Utils.updateShareUrls();
        return Renderer.renderList(true);
      } else {
        AppState.requestId = 0;
        // Detail page - completely hide filters
        if (filtersEl) {
          filtersEl.style.display = 'none';
          filtersEl.style.visibility = 'hidden';
          filtersEl.style.height = '0';
          filtersEl.style.overflow = 'hidden';
          filtersEl.style.margin = '0';
          filtersEl.style.padding = '0';
        }
        return Renderer.renderDetail(slug);
      }
    }
  };

  // ===== KEYBOARD SHORTCUTS =====
  const KeyboardShortcuts = {
    init() {
      document.addEventListener('keydown', this.handleKeydown.bind(this));
    },

    handleKeydown(e) {
      // Ignore if user is typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.key) {
        case '/':
          e.preventDefault();
          const searchInput = Utils.$('#q');
          if (searchInput) searchInput.focus();
          break;
          
        case 'Escape':
          const activeElement = document.activeElement;
          if (activeElement && activeElement.blur) activeElement.blur();
          break;
          
      }
    }
  };

  // ===== SCROLL MANAGEMENT =====
  const ScrollManager = {
    init() {
      const header = Utils.$('#hdr');
      if (!header) return;

      const onScroll = () => {
        const scrolled = window.scrollY > 20;
        header.classList.toggle('is-scrolled', scrolled);
        
        // Ensure header is always visible
        header.style.display = 'block';
        header.style.visibility = 'visible';
        header.style.opacity = '1';
        header.style.transform = 'none';
        
        // Add glass effect when scrolled
        if (scrolled) {
          const isDark = AppState.theme === 'dark';
          if (isDark) {
            header.style.background = 'rgba(17, 24, 39, 0.8)';
            header.style.backdropFilter = 'blur(20px) saturate(180%)';
            header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            header.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.3)';
          } else {
            header.style.background = 'rgba(255, 255, 255, 0.8)';
            header.style.backdropFilter = 'blur(20px) saturate(180%)';
            header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.2)';
            header.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.1)';
          }
        } else {
          header.style.background = 'var(--bg)';
          header.style.backdropFilter = 'saturate(120%) blur(6px)';
          header.style.borderBottom = '1px solid var(--line-2)';
          header.style.boxShadow = 'none';
        }
      };

      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    }
  };

  // ===== APP INITIALIZATION =====
  const App = {
    async init() {
      try {
        ThemeManager.init();
        NetworkManager.init();
        ScrollManager.init();
        KeyboardShortcuts.init();
        Router.init();
        
        const slug = Utils.normalizeSlug(location.pathname);
        const filtersEl = Utils.$('#filters');
        if (filtersEl) {
          filtersEl.style.display = slug ? 'none' : 'block';
        }
        
// Service worker disabled for now to avoid stale HTML issues on static routes
if ('serviceWorker' in navigator) {
  try {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.unregister();
  } catch (_) {}
}

        console.log('Elixiary app initialized successfully');
        
      } catch (error) {
        console.error('App initialization failed:', error);
        ErrorHandler.showError('Failed to initialize the application.', true);
      }
    }
  };

  // ===== GLOBAL ERROR HANDLER =====
  window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    Utils.announce('An error occurred. Please try refreshing the page.');
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    event.preventDefault(); // Prevent the default browser handling
  });

  // ===== BOOT =====
  document.addEventListener('DOMContentLoaded', App.init);

  // Export for debugging in development
  if (typeof window !== 'undefined') {
    window.ElixiaryApp = {
      AppState,
      Utils,
      CacheManager,
      APIClient,
      ThemeManager,
      ErrorHandler,
      FilterManager,
      Renderer,
      Router
    };
  }

  // ---- Analytics helpers ----
  function trackPageView() {
    if (typeof gtag !== 'function') return;
    gtag('event', 'page_view', {
      page_title: document.title,
      page_location: location.href,
      page_path: location.pathname
    });
  }

</script>

<script>
/* ---------- Minimal Consent Banner (Analytics-only vs Essentials) ---------- */
(function(){
  const KEY = 'elixiary.consent.v1';
  const saved = JSON.parse(localStorage.getItem(KEY) || 'null');

  // Apply saved choice on load
  function apply(consented){
    gtag('consent', 'update', {
      analytics_storage: consented ? 'granted' : 'denied',
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });
  }

  if (saved && typeof saved.analytics === 'boolean') {
    apply(saved.analytics);
    return; // already decided, no banner
  }

  // Create simple inline banner
  const bar = document.createElement('div');
  bar.style.cssText =
    'position:fixed;inset:auto 12px 12px 12px;z-index:99999;background:#111827;color:#fff;padding:12px 14px;border-radius:10px;font:14px/1.4 system-ui;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;gap:10px;align-items:center;flex-wrap:wrap;';
  bar.innerHTML = `
    <span>We use anonymous analytics to improve Elixiary. OK to enable?</span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="consent-allow" style="background:#10B981;color:#fff;border:0;border-radius:999px;padding:8px 12px;cursor:pointer">Allow analytics</button>
      <button id="consent-essentials" style="background:#374151;color:#fff;border:0;border-radius:999px;padding:8px 12px;cursor:pointer">Essentials only</button>
    </div>
  `;
  document.body.appendChild(bar);

  document.getElementById('consent-allow').onclick = () => {
    localStorage.setItem(KEY, JSON.stringify({ analytics:true, ts:Date.now() }));
    apply(true);
    bar.remove();
  };
  document.getElementById('consent-essentials').onclick = () => {
    localStorage.setItem(KEY, JSON.stringify({ analytics:false, ts:Date.now() }));
    apply(false);
    bar.remove();
  };
})();
</script>

<script>
/* ---------------------- SPA + Custom Events Wiring ----------------------- */
(function(){
  // Search term (fires when user commits the field)
  const q = document.getElementById('q');
  if (q){
    let last='';
    q.addEventListener('change', () => {
      const term = q.value.trim();
      if (term && term !== last){
        last = term;
        gtag('event', 'search', { search_term: term });
      }
    });
  }

  // Filter chip clicks
  document.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if (!chip) return;
    gtag('event', 'filter_change', {
      filter_name: chip.dataset.k || 'category',
      filter_value: chip.dataset.v || 'all'
    });
  });

  // Load more (button)
  document.addEventListener('click', (e)=>{
    const btn = e.target.id === 'moreBtn' ? e.target : e.target.closest('#moreBtn');
    if (!btn) return;
    gtag('event', 'load_more', {
      next_page: (window.ElixiaryApp?.AppState?.page || 1) + 1,
      reason: 'button'
    });
  });

  // Load more (infinite scroll hook, if available)
  if (window.ElixiaryApp?.InfiniteScroll){
    const IS = window.ElixiaryApp.InfiniteScroll;
    const orig = IS.loadNextPage;
    IS.loadNextPage = async function(){
      gtag('event', 'load_more', {
        next_page: (window.ElixiaryApp?.AppState?.page || 1) + 1,
        reason: 'infinite_scroll'
      });
      return orig.apply(this, arguments);
    };
  }

  // View item (wrap detail renderer to emit a GA4 'view_item')
  if (window.ElixiaryApp?.Renderer){
    const R = window.ElixiaryApp.Renderer;
    const origDetail = R.renderDetail;
    R.renderDetail = async function(slug){
      const recipe = await origDetail.call(R, slug);
      try{
        if (recipe && typeof gtag === 'function'){
          gtag('event', 'view_item', {
            items: [{
              item_id: String(slug),
              item_name: recipe.name || String(slug),
              item_category: recipe.category || ''
            }]
          });
        }
      }catch(_){}
      return recipe;
    };
  }

  // Outbound link clicks
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href]');
    if (!a) return;
    const u = new URL(a.href, location.href);
    if (u.origin !== location.origin){
      gtag('event', 'outbound_click', {
        link_url: u.href,
        link_text: (a.textContent || '').trim().slice(0,80)
      });
    }
  });

  // Exceptions
  window.addEventListener('error', (e)=>{
    gtag('event', 'exception', {
      description: String(e.error?.message || e.message || 'Unknown error'),
      fatal: false
    });
  });
  window.addEventListener('unhandledrejection', (e)=>{
    gtag('event', 'exception', {
      description: String(e.reason?.message || e.reason || 'Promise rejection'),
      fatal: false
    });
  });
})();
</script>


</body>
</html>
